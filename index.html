<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ongod Gadget Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; animation: fadeIn 8s; }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        .container { max-width: 400px; margin: 60px auto; background: #fff; padding: 30px 20px 20px 20px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h2 { text-align: center; margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 10px 0 0 0; border-radius: 5px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: #fff; border: none; margin-bottom: 10px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #218838; }
        .error { color: #d00; text-align: center; margin-bottom: 10px; }
        .hidden { display: none; }
        .user-bar { background: #eee; padding: 10px; text-align: right; font-size: 15px; }
        .user-bar button { width: auto; padding: 5px 12px; margin-left: 10px; background: #dc3545; border-radius: 4px; font-size: 14px; }
        .user-bar button:hover { background: #b52a37; }
        header { background: #333; color: #fff; padding: 10px 0; text-align: left; position: relative; }
        .logo img { width: 120px; height: auto; margin-left: 20px; }
        main { padding: 20px; }
        .gadget-section { margin-bottom: 40px; }
        .section-title { font-size: 24px; margin-bottom: 16px; color: #333; font-weight: bold; }
        .gadget-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .gadget-item { background: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 12px; margin-bottom: 0; box-sizing: border-box; text-align: center; box-shadow: 0 1px 4px #0001; display: flex; flex-direction: column; align-items: center; }
        .gadget-item img { max-width: 100%; height: 110px; object-fit: cover; border-radius: 5px; }
        .gadget-item h3 { font-size: 18px; margin: 8px 0 6px 0; color: #333; }
        .gadget-item .prices { font-size: 15px; color: #555; margin-bottom: 8px; }
        .action-buttons { display: flex; gap: 14px; margin-top: 10px; justify-content: center; width: 100%; }
        .gadget-item button { width: auto; padding: 7px 18px; margin: 0; font-size: 15px; }
        .cart { background: #fff; padding: 16px; border-radius: 5px; margin-top: 20px; box-shadow: 0 1px 4px #0001; }
        .cart h2 { font-size: 40px; margin-bottom: 14px; color: #333; }
        .cart ul { list-style-type: none; padding: 0; }
        .cart li { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 7px 0; border-bottom: 1px solid #eee; font-size: 9px; }
        .cart li button { background: #dc3545; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 13px; }
        .cart li button:hover { background: #b52a37; }
        address { text-align: center; margin-top: 20px; font-style: normal; font-size: 15px; }
        footer { background: #333; color: #fff; text-align: center; padding: 10px 0; position: relative; bottom: 0; width: 100%; font-size: 15px; }
        footer a { color: #fff; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        #mapModal, #checkoutModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0005; z-index:3000; }
        #mapModalBox, #checkoutModalBox { background:#fff;padding:24px 18px;border-radius:8px;max-width:400px;margin:80px auto;position:relative; }
        #map { width: 350px; height: 200px; border-radius: 8px; margin-bottom:12px; }
        #placeImage { width: 350px; height: 120px; border-radius: 8px; object-fit: cover; margin-bottom: 12px; }
        #mapModalBox button, #checkoutModalBox button { margin-top: 10px; }
        #paymentModal { display:none; position:fixed; top:0; left:0;width:100vw;height:100vh;background:#0005;z-index:4000;}
        #paymentModalBox { background:#fff;padding:24px 18px;border-radius:8px;max-width:400px;margin:80px auto;position:relative;}
        #paymentModalBox button { margin-top: 10px; }
        #adminPanel { display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:5000;}
        #adminPanelBox {background:#fff;padding:24px 18px;border-radius:8px;max-width:900px;margin:40px auto;position:relative;}
        #notificationIcon {position:fixed;top:18px;right:24px;z-index:9999;cursor:pointer;}
        #notificationIcon svg {vertical-align:middle;}
        #notifDot {display:none;position:absolute;top:2px;right:2px;width:10px;height:10px;background:#dc3545;border-radius:50%;}
        #notification { display:none;position:fixed;top:60px;right:32px;background:#333;color:#fff;padding:14px 28px;border-radius:6px;z-index:9999;font-size:1.1rem;box-shadow:0 2px 8px #0003;min-width:220px;text-align:center;}
        @media (max-width: 900px) {
            .gadget-list { grid-template-columns: repeat(2, 1fr); }
            #map, #placeImage { width: 95vw; }
            #mapModalBox, #paymentModalBox, #adminPanelBox, #checkoutModalBox { max-width: 95vw; }
        }
        @media (max-width: 600px) {
            .gadget-list { grid-template-columns: repeat(2, 1fr); }
            main { padding: 8px; }
            #map, #placeImage { width: 95vw; }
            #mapModalBox, #paymentModalBox, #adminPanelBox, #checkoutModalBox { max-width: 95vw; }
        }
        #adminOrders table { width: 100%; border-collapse: collapse; }
        #adminOrders th, #adminOrders td { border: 1px solid #ddd; padding: 6px 4px; font-size: 13px; }
        #adminOrders th { background: #333; color: #fff; }
        #adminOrders tr:nth-child(even) { background: #f9f9f9; }
    </style>
</head>
<body>
    <audio id="clickSound" src="mouse-click-331781.mp3" preload="auto"></audio>
    <!-- Notification Icon -->
    <div id="notificationIcon">
      <span style="font-size:2rem;position:relative;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
          <path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6V11c0-3.07-1.63-5.64-5-6.32V4a1 1 0 1 0-2 0v.68C7.63 5.36 6 7.92 6 11v5l-1.29 1.29A1 1 0 0 0 6 19h12a1 1 0 0 0 .71-1.71L18 16z" fill="#333"/>
        </svg>
        <span id="notifDot"></span>
      </span>
    </div>
    <div id="notification"></div>
    <!-- Notification Messages Modal -->
    <div id="notifMessagesModal" style="display:none;position:fixed;top:60px;right:32px;background:#fff;color:#333;padding:18px 28px;border-radius:8px;z-index:9999;min-width:260px;max-width:90vw;box-shadow:0 2px 8px #0003;">
      <h4 style="margin-top:0;">Your Messages</h4>
      <ul id="notifMessagesList" style="padding-left:18px;font-size:1rem;max-height:300px;overflow:auto;"></ul>
      <button onclick="closeNotifMessages()" style="margin-top:10px;">Close</button>
    </div>
    <div id="loginPage" class="container">
        <h2>Login</h2>
        <div class="error" id="loginError"></div>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <button onclick="showRegister()">Register</button>
    </div>
    <div id="registerPage" class="container hidden">
        <h2>Register</h2>
        <div class="error" id="registerError"></div>
        <input type="text" id="regName" placeholder="Full Name" required>
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password" required>
        <input type="text" id="regPhone" placeholder="Phone Number" required>
        <select id="regState" required onchange="populateAreas('regState','regArea')">
            <option value="">Select State</option>
        </select>
        <select id="regArea" required onchange="populateStreets('regState','regArea','regStreet')">
            <option value="">Select Area</option>
        </select>
        <select id="regStreet" required>
            <option value="">Select Street</option>
        </select>
        <button onclick="register()">Register</button>
        <button onclick="showLogin()">Back to Login</button>
    </div>
    <div id="mainPage" class="hidden">
        <div class="user-bar">
            Logged in as <b id="userName"></b>
            <button onclick="logout()">Logout</button>
        </div>
        <header>
            <div class="logo">
                <img src="logo.png" alt="Ongod Gadget Logo">
            </div>
        </header>
        <main>
            <section class="gadget-section">
                <h2 class="section-title">Latest Phones</h2>
                <div class="gadget-list" id="phone-list"></div>
                <h2 class="section-title">Latest Laptops</h2>
                <div class="gadget-list" id="laptop-list"></div>
                <h2 class="section-title">Accessories</h2>
                <div class="gadget-list" id="accessory-list"></div>
            </section>
            <section class="cart">
                <h2>Your Cart</h2>
                <ul id="cart-items"></ul>
                <button onclick="checkoutCart()">Checkout</button>
                <button onclick="clearCart()">Clear Cart</button>
            </section>
        </main>
        <address>
            <p>Contact us at: 
                <a href="tel:+2349138154963">+234 913 815 4963</a></p>
                <a href="mailto:ayomideoluniyi49@gmail.com">ayomideoluniyi49@gmail.com</a>
        </address>
        <footer>
            <p>&copy; 2025 Ongod Gadget. All rights reserved. | 
            <a href="#" onclick="showAdminPanel()">Admin Panel</a></p>
        </footer>
    </div>
    <!-- Map Modal -->
    <div id="mapModal">
      <div id="mapModalBox">
        <div id="map"></div>
        <img id="placeImage" src="" alt="Place Image" style="display:none;">
        <button onclick="closeMapModal()">Cancel</button>
      </div>
    </div>
    <!-- Payment Modal -->
    <div id="paymentModal">
      <div id="paymentModalBox">
        <h3>Payment Method</h3>
        <select id="paymentMethod">
            <option value="transfer">Bank Transfer</option>
            <option value="card">Card Payment</option>
            <option value="ussd">USSD</option>
            <option value="cash">Cash on Delivery</option>
        </select>
        <button onclick="finishOrder()">Pay & Send to Admin</button>
      </div>
    </div>
    <!-- Admin Panel Modal -->
    <div id="adminPanel">
      <div id="adminPanelBox">
        <h2>Admin Panel - Orders</h2>
        <div id="adminOrders" style="max-height:500px;overflow:auto;"></div>
        <button onclick="closeAdminPanel()">Close</button>
        <!-- Broadcast Message Form (Admin Only) -->
        <hr>
        <h3>Send Broadcast Message</h3>
        <form id="broadcastForm">
            <input type="text" id="broadcastMsg" placeholder="Type message to all users" required>
            <button type="submit">Send Message</button>
        </form>
      </div>
    </div>
    <!-- Checkout Modal -->
    <div id="checkoutModal">
      <div id="checkoutModalBox">
        <h3>Choose Order Type</h3>
        <button onclick="checkoutPick('Pickup')">Pick Up</button>
        <button onclick="checkoutPick('Delivery')">Delivery</button>
        <button onclick="closeCheckoutModal()">Cancel</button>
      </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // --- AREA, STATE, STREET LOGIC ---
    const AVAILABLE_AREAS = {
        "Lagos": {
            "Ikeja": ["Allen Avenue", "Opebi", "Alausa", "Oba Akran"],
            "Yaba": ["Herbert Macaulay", "Commercial Ave", "Tejuosho", "Sabo"],
            "Lekki": ["Admiralty Way", "Lekki Phase 1", "Chevron", "VGC"],
            "Surulere": ["Bode Thomas", "Adeniran Ogunsanya", "Aguda", "Ijesha"],
            "Ikorodu": ["Ijede Road", "Ebute", "Agbede", "Igbogbo"],
            "Ajah": ["Abraham Adesanya", "Sangotedo", "Badore", "Ilaje"],
            "Victoria Island": ["Ozumba Mbadiwe", "Akin Adesola", "Ahmadu Bello", "Adeola Odeku"],
            "Agege": ["Dopemu", "Oko Oba", "Pen Cinema", "Capitol Road"],
            "Oshodi": ["Oshodi Road", "Bolade", "Mafoluku", "Shogunle"],
            "Badagry": ["Ajara", "Ibereko", "Topo", "Gbaji"]
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const stateSelect = document.getElementById('regState');
        stateSelect.innerHTML = '<option value="">Select State</option>';
        Object.keys(AVAILABLE_AREAS).forEach(state => {
            const opt = document.createElement('option');
            opt.value = state;
            opt.textContent = state;
            stateSelect.appendChild(opt);
        });
    });

    function populateAreas(stateId, areaId) {
        const state = document.getElementById(stateId).value;
        const areaSelect = document.getElementById(areaId);
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        document.getElementById('regStreet').innerHTML = '<option value="">Select Street</option>';
        if (AVAILABLE_AREAS[state]) {
            Object.keys(AVAILABLE_AREAS[state]).forEach(area => {
                const opt = document.createElement('option');
                opt.value = area;
                opt.textContent = area;
                areaSelect.appendChild(opt);
            });
        }
    }
    function populateStreets(stateId, areaId, streetId) {
        const state = document.getElementById(stateId).value;
        const area = document.getElementById(areaId).value;
        const streetSelect = document.getElementById(streetId);
        streetSelect.innerHTML = '<option value="">Select Street</option>';
        if (AVAILABLE_AREAS[state] && AVAILABLE_AREAS[state][area]) {
            AVAILABLE_AREAS[state][area].forEach(street => {
                const opt = document.createElement('option');
                opt.value = street;
                opt.textContent = street;
                streetSelect.appendChild(opt);
            });
        }
    }

    // --- NOTIFICATION LOGIC ---
    function saveNotification(msg) {
        let messages = JSON.parse(localStorage.getItem('user_messages') || '[]');
        messages.unshift({ msg, time: new Date().toLocaleString() });
        localStorage.setItem('user_messages', JSON.stringify(messages.slice(0, 50)));
    }
    function showNotification(msg, color = "#333") {
        const n = document.getElementById('notification');
        const dot = document.getElementById('notifDot');
        n.textContent = msg;
        n.style.background = color;
        n.style.display = 'block';
        dot.style.display = 'block';
        saveNotification(msg);
        clearTimeout(window._notifTimeout);
        window._notifTimeout = setTimeout(() => {
            n.style.display = 'none';
            dot.style.display = 'none';
        }, 3000);
    }
    function showNotifMessages() {
        const modal = document.getElementById('notifMessagesModal');
        const list = document.getElementById('notifMessagesList');
        let messages = JSON.parse(localStorage.getItem('user_messages') || '[]');
        if (messages.length === 0) {
            list.innerHTML = "<li>No messages yet.</li>";
        } else {
            list.innerHTML = messages.map(m => `<li>${m.msg}<br><small style="color:#888;">${m.time}</small></li>`).join('');
        }
        modal.style.display = 'block';
    }
    function closeNotifMessages() {
        document.getElementById('notifMessagesModal').style.display = 'none';
    }
    document.getElementById('notificationIcon').onclick = showNotifMessages;
    document.getElementById('notification').onclick = showNotifMessages;

    // --- SOUND LOGIC ---
    function playClick() {
        const audio = document.getElementById('clickSound');
        if (audio) {
            audio.currentTime = 0;
            audio.play();
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        document.body.addEventListener('click', function(e) {
            if (e.target.tagName === "BUTTON" || e.target.classList.contains('gadget-item') || e.target.id === "notificationIcon") {
                playClick();
            }
        });
    });

    // --- LOGIN/REGISTER LOGIC ---
    function showLogin() {
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('registerPage').classList.add('hidden');
        document.getElementById('mainPage').classList.add('hidden');
    }
    function showRegister() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('registerPage').classList.remove('hidden');
        document.getElementById('mainPage').classList.add('hidden');
    }
    function showMain() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('registerPage').classList.add('hidden');
        document.getElementById('mainPage').classList.remove('hidden');
    }
    function getCurrentUser() {
        return JSON.parse(localStorage.getItem('user'));
    }
    function setCurrentUser(user) {
        localStorage.setItem('user', JSON.stringify(user));
    }
    function login() {
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const user = JSON.parse(localStorage.getItem('user_' + email));
        if (!user || user.password !== password) {
            document.getElementById('loginError').textContent = 'Invalid email or password.';
            showNotification("Invalid email or password!", "#dc3545");
            return;
        }
        setCurrentUser(user);
        showMain();
        onMainLoad();
    }
    function register() {
        const name = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim().toLowerCase();
        const password = document.getElementById('regPassword').value;
        const phone = document.getElementById('regPhone').value.trim();
        const state = document.getElementById('regState').value;
        const area = document.getElementById('regArea').value;
        const street = document.getElementById('regStreet').value;
        if (!name || !email || !password || !phone || !state || !area || !street) {
            document.getElementById('registerError').textContent = 'Please fill all fields.';
            showNotification("Please fill all fields.", "#dc3545");
            return;
        }
        if (phone.length < 10) {
            document.getElementById('registerError').textContent = 'Please enter a valid phone number.';
            showNotification("Please enter a valid phone number.", "#dc3545");
            return;
        }
        if (localStorage.getItem('user_' + email)) {
            document.getElementById('registerError').textContent = 'Email already registered.';
            showNotification("Email already registered.", "#dc3545");
            return;
        }
        const user = { name, email, password, phone, state, area, street };
        localStorage.setItem('user_' + email, JSON.stringify(user));
        setCurrentUser(user);
        showMain();
        onMainLoad();
        showNotification("Registration successful!", "#28a745");
    }

    // --- MAP LOGIC ---
    let map, mapMarker;
    function showMapModal() {
        document.getElementById('mapModal').style.display = 'block';
        document.getElementById('placeImage').style.display = 'none';
        const user = getCurrentUser();
        const address = `${user.street}, ${user.area}, ${user.state}, Nigeria`;
        setTimeout(() => {
            if (map) map.remove();
            map = L.map('map').setView([9.082, 8.6753], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(r=>r.json())
            .then(res=>{
                if(res && res[0]) {
                    let lat = parseFloat(res[0].lat), lng = parseFloat(res[0].lon);
                    map.setView([lat, lng], 16);
                    mapMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup(address).openPopup();
                    let img = document.getElementById('placeImage');
                    img.src = `https://source.unsplash.com/350x120/?${encodeURIComponent(user.street + " " + user.area + " " + user.state + ", Nigeria")}`;
                    img.onerror = function() {
                        img.src = "https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=350&q=80";
                    };
                    img.style.display = 'block';
                } else {
                    map.setView([9.082, 8.6753], 6);
                    mapMarker = L.marker([9.082, 8.6753]).addTo(map)
                        .bindPopup("Address not found").openPopup();
                    let img = document.getElementById('placeImage');
                    img.src = "https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=350&q=80";
                    img.style.display = 'block';
                }
            });
        }, 200);
    }
    function closeMapModal() {
        document.getElementById('mapModal').style.display = 'none';
        showPaymentModal();
    }

    // --- CART, GADGETS, CHECKOUT, PAYMENT LOGIC ---
    let orderStatusInterval = null;
    function startOrderStatusPolling() {
        if (orderStatusInterval) clearInterval(orderStatusInterval);
        checkOrderStatusAndNotify();
        orderStatusInterval = setInterval(checkOrderStatusAndNotify, 10000);
    }
    function logout() {
        localStorage.removeItem('user');
        if (orderStatusInterval) clearInterval(orderStatusInterval);
        showLogin();
        showNotification("Logged out.", "#333");
    }
    function addToCart(name, price) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.push({ name, price });
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
        showNotification("Added to cart!", "#28a745");
    }
    function removeFromCart(index) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
        showNotification("Removed from cart.", "#333");
    }
    function clearCart() {
        localStorage.removeItem('cart');
        renderCart();
        showNotification("Cart cleared.", "#333");
    }
    function renderCart() {
        const cartList = document.getElementById('cart-items');
        cartList.innerHTML = '';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.forEach((item, i) => {
            const li = document.createElement('li');
            li.textContent = item.name + ' - #' + item.price.toLocaleString();
            const btn = document.createElement('button');
            btn.textContent = 'Remove';
            btn.style.marginLeft = '10px';
            btn.onclick = () => removeFromCart(i);
            li.appendChild(btn);
            cartList.appendChild(li);
        });
    }
    function checkoutCart() {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        if (cart.length === 0) {
            showNotification('Your cart is empty.', "#dc3545");
            return;
        }
        document.getElementById('checkoutModal').style.display = 'block';
    }
    function closeCheckoutModal() {
        document.getElementById('checkoutModal').style.display = 'none';
    }
    function checkoutPick(type) {
        closeCheckoutModal();
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let user = getCurrentUser();
        if (!user) {
            showNotification('Please login first.', "#dc3545");
            return;
        }
        let total = cart.reduce((sum, item) => sum + item.price, 0);
        let order = {
            date: new Date().toISOString(),
            type: type,
            name: user.name,
            phone: user.phone,
            email: user.email,
            items: cart.map(i => i.name).join(', '),
            details: type === "Pickup" ? "Ongod Gadget Store, Ikeja, Lagos" : `${user.street}, ${user.area}, ${user.state}, Nigeria`,
            total: total,
            status: "pending"
        };
        pendingOrder = order;
        if (type === "Delivery") {
            showMapModal();
        } else {
            showPaymentModal();
        }
        clearCart();
    }
    let pendingOrder = null;
    function buyNow(name, pickup, delivery) {
        const user = getCurrentUser();
        if (!user) {
            showNotification('Please login first.', "#dc3545");
            return;
        }
        let choice = prompt('Do you want to pick up or have it delivered?\n1. Pick up\n2. Delivery:');
        if (choice === '1') {
            pendingOrder = {
                date: new Date().toISOString(),
                type: 'Pickup',
                name: user.name,
                phone: user.phone,
                email: user.email,
                items: name,
                details: "Ongod Gadget Store, Ikeja, Lagos",
                total: pickup,
                status: "pending"
            };
            showPaymentModal();
        } else if (choice === '2') {
            pendingOrder = {
                date: new Date().toISOString(),
                type: 'Delivery',
                name: user.name,
                phone: user.phone,
                email: user.email,
                items: name,
                details: `${user.street}, ${user.area}, ${user.state}, Nigeria`,
                total: delivery,
                status: "pending"
            };
            showMapModal();
        } else {
            showNotification('Invalid choice. Please try again.', "#dc3545");
        }
    }
    function showPaymentModal() {
        document.getElementById('paymentModal').style.display = 'block';
    }
    const SHEETBEST_URL = 'https://api.sheetbest.com/sheets/4115eaae-b505-4191-83bf-a0d58cec1644';
    function finishOrder() {
        document.getElementById('paymentModal').style.display = 'none';
        let user = getCurrentUser();
        let order = pendingOrder;
        if (!order) return;
        order.status = document.getElementById('paymentMethod').value;
        fetch(SHEETBEST_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(order)
        }).then(() => {
            showNotification("Order sent to admin!", "#28a745");
        }).catch(() => {
            showNotification("Order failed to send to admin!", "#dc3545");
        });
        pendingOrder = null;
    }

    // --- ADMIN PANEL LOGIC (SHOW ORDERS FROM SHEET) ---
    function showAdminPanel() {
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminOrders').innerHTML = 'Loading...';
        fetch(SHEETBEST_URL)
            .then(res => res.json())
            .then(data => {
                if (!data.length) {
                    document.getElementById('adminOrders').innerHTML = '<p>No orders yet.</p>';
                    return;
                }
                let html = `<table>
                  <tr>
                    <th>Date</th>
                    <th>Order Type</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Items</th>
                    <th>Address/Details</th>
                    <th>Total (₦)</th>
                    <th>Status</th>
                    <th>Action</th>
                    <th>Message</th>
                  </tr>`;
                data.reverse().forEach(order => {
                  html += `<tr>
                    <td>${order.date ? order.date.replace('T', ' ').slice(0, 16) : ''}</td>
                    <td>${order.type || ''}</td>
                    <td>${order.name || ''}</td>
                    <td>${order.phone || ''}</td>
                    <td>${order.email || ''}</td>
                    <td>${order.items || ''}</td>
                    <td>${order.details || ''}</td>
                    <td>${order.total ? Number(order.total).toLocaleString() : ''}</td>
                    <td>${order.status || ''}</td>
                    <td><button onclick="markConfirmed('${order.date}')">Confirm</button></td>
                    <td>${order.message || ''}</td>
                  </tr>`;
                });
                html += `</table>`;
                document.getElementById('adminOrders').innerHTML = html;
            })
            .catch(() => {
                document.getElementById('adminOrders').innerHTML = '<p style="color:#d00;">Failed to load orders.</p>';
            });
    }
    function closeAdminPanel() {
        document.getElementById('adminPanel').style.display = 'none';
    }
    function markConfirmed(date) {
        alert('Order with date ' + date + ' marked as Confirmed!');
        // Here you can send a PATCH/PUT request to SheetBest to update the status if you want
    }

    // --- SHOW-ONCE PER MESSAGE LOGIC ---
    function getShownMessageIds() {
        return JSON.parse(localStorage.getItem('shown_message_ids') || '[]');
    }
    function addShownMessageId(id) {
        let ids = getShownMessageIds();
        ids.push(id);
        localStorage.setItem('shown_message_ids', JSON.stringify(ids));
    }
    function showNotificationOnce(msg, color = "#333", id = null) {
        if (id) {
            let ids = getShownMessageIds();
            if (ids.includes(id)) return; // Already shown, skip
            addShownMessageId(id);
        }
        showNotification(msg, color);
    }
    function checkOrderStatusAndNotify() {
        const user = getCurrentUser();
        if (!user) return;
        fetch(SHEETBEST_URL)
            .then(res => res.json())
            .then(data => {
                const orders = data.filter(o => o.email && o.email.toLowerCase() === user.email.toLowerCase());
                // Show alert for each new message (not shown before)
                orders.forEach(order => {
                    if (order.message && order.status === "Confirmed") {
                        showNotificationOnce(order.message, "#28a745", order.date);
                    }
                });
            });
    }

    function onMainLoad() {
        const user = getCurrentUser();
        if (!user) {
            showLogin();
            return;
        }
        document.getElementById('userName').textContent = user.name;
        renderCart();
        renderGadgets();
        startOrderStatusPolling();
    }
    function renderGadgets() {
        const phones = [
            { img: "phone1.webp", name: "Redmi Note 14", pickup: 262983, delivery: 306813 },
            { img: "phone2.jpeg", name: "iPhone 14", pickup: 278279, delivery: 324659 },
            { img: "phone15.jpeg", name: "Samsung Galaxy S22", pickup: 294000, delivery: 343000 },
            { img: "phone5.jpeg", name: "Google Pixel 6", pickup: 310800, delivery: 362600 },
            { img: "phone6.jpg", name: "OnePlus 9 Pro", pickup: 324000, delivery: 378000 },
            { img: "phone7.jpeg", name: "Tecno Camon 20", pickup: 144000, delivery: 168000 },
            { img: "phone8.jpeg", name: "Infinix Hot 30", pickup: 117600, delivery: 137200 },
            { img: "phone16.jpeg", name: "Samsung Galaxy A54", pickup: 216000, delivery: 252000 },
            { img: "phone13.jpeg", name: "iPhone 13 Pro Max", pickup: 540000, delivery: 630000 },
            { img: "phone11.jpeg", name: "Realme GT 5 Pro", pickup: 350000, delivery: 400000 },
            { img: "phone12.jpeg", name: "Nokia G60", pickup: 95000, delivery: 110000 },
            { img: "phone14.jpeg", name: "Vivo V27", pickup: 180000, delivery: 210000 },
            { img: "phone17.jpeg", name: "iPhone 15 Pro", pickup: 900000, delivery: 1050000 },
            { img: "phone18.jpeg", name: "Tecno Spark 20", pickup: 85000, delivery: 95000 },
            { img: "phone19.jpeg", name: "Samsung Galaxy Z Fold 5", pickup: 1200000, delivery: 1350000 }
        ];
        const laptops = [
            { img: "laptop1.jpeg", name: "Dell Inspiron 15", pickup: 180000, delivery: 210000 },
            { img: "laptop2.jpeg", name: "HP Pavilion x360", pickup: 240000, delivery: 280000 },
            { img: "laptop3.jpeg", name: "Lenovo ThinkPad X1", pickup: 300000, delivery: 350000 },
            { img: "laptop9.jpeg", name: "Asus ZenBook 14", pickup: 360000, delivery: 420000 },
            { img: "laptop5.webp", name: "Apple MacBook Air M2", pickup: 720000, delivery: 840000 },
            { img: "laptop4.jpeg", name: "Acer Aspire 5", pickup: 216000, delivery: 252000 },
            { img: "laptop8.webp", name: "HP EliteBook 840", pickup: 420000, delivery: 490000 },
            { img: "laptop7.webp", name: "Microsoft Surface Laptop 5", pickup: 600000, delivery: 700000 },
            { img: "laptop10.jpeg", name: "MSI GF63 Thin", pickup: 410000, delivery: 470000 },
            { img: "laptop11.jpeg", name: "Razer Blade 15", pickup: 900000, delivery: 1050000 },
            { img: "laptop12.jpeg", name: "Apple MacBook Pro M3", pickup: 1200000, delivery: 1350000 },
            { img: "laptop13.jpeg", name: "Dell XPS 13", pickup: 650000, delivery: 750000 }
        ];
        const accessories = [
            { img: "airpod.jpeg", name: "Apple AirPods Pro", pickup: 85000, delivery: 95000 },
            { img: "samsungbunds.jpeg", name: "Samsung Galaxy Buds", pickup: 60000, delivery: 70000 },
            { img: "apowerbanknker.jpeg", name: "Anker Power Bank 20000mAh", pickup: 35000, delivery: 40000 },
            { img: "logitechmouse.jpeg", name: "Logitech MX Master 3 Mouse", pickup: 32000, delivery: 37000 },
            { img: "sandiskssd.jpeg", name: "SanDisk 1TB SSD", pickup: 65000, delivery: 75000 },
            { img: "jblgo3.jpeg", name: "JBL Go 3 Speaker", pickup: 18000, delivery: 22000 },
            { img: "ankercharger.jpeg", name: "Anker 65W Charger", pickup: 25000, delivery: 30000 },
            { img: "applewatch.jpeg", name: "Apple Watch Series 9", pickup: 220000, delivery: 250000 },
            { img: "fitbit.jpeg", name: "Fitbit Versa 4", pickup: 90000, delivery: 105000 },
            { img: "logitechkeyboard.jpeg", name: "Logitech K380 Keyboard", pickup: 18000, delivery: 22000 }
        ];
        const phoneList = document.getElementById('phone-list');
        const laptopList = document.getElementById('laptop-list');
        const accessoryList = document.getElementById('accessory-list');
        phoneList.innerHTML = '';
        laptopList.innerHTML = '';
        accessoryList.innerHTML = '';
        phones.forEach(phone => {
            phoneList.innerHTML += `
                <div class="gadget-item">
                    <img src="${phone.img}" alt="${phone.name}" onerror="this.onerror=null;this.src='https://source.unsplash.com/200x110/?phone,${encodeURIComponent(phone.name)}';">
                    <h3>${phone.name}</h3>
                    <div class="prices">
                        <span>Pickup Total: #${phone.pickup.toLocaleString()}</span><br>
                        <span>Delivery Total: #${phone.delivery.toLocaleString()}</span>
                    </div>
                    <div class="action-buttons">
                        <button onclick="buyNow('${phone.name}', ${phone.pickup}, ${phone.delivery})">Buy Now</button>
                        <button onclick="addToCart('${phone.name}', ${phone.pickup})">Add to Cart</button>
                    </div>
                </div>
            `;
        });
        laptops.forEach(laptop => {
            laptopList.innerHTML += `
                <div class="gadget-item">
                    <img src="${laptop.img}" alt="${laptop.name}" onerror="this.onerror=null;this.src='https://source.unsplash.com/200x110/?laptop,${encodeURIComponent(laptop.name)}';">
                    <h3>${laptop.name}</h3>
                    <div class="prices">
                        <span>Pickup Total: #${laptop.pickup.toLocaleString()}</span><br>
                        <span>Delivery Total: #${laptop.delivery.toLocaleString()}</span>
                    </div>
                    <div class="action-buttons">
                        <button onclick="buyNow('${laptop.name}', ${laptop.pickup}, ${laptop.delivery})">Buy Now</button>
                        <button onclick="addToCart('${laptop.name}', ${laptop.pickup})">Add to Cart</button>
                    </div>
                </div>
            `;
        });
        accessories.forEach(acc => {
            accessoryList.innerHTML += `
                <div class="gadget-item">
                    <img src="${acc.img}" alt="${acc.name}" onerror="this.onerror=null;this.src='https://source.unsplash.com/200x110/?accessory,${encodeURIComponent(acc.name)}';">
                    <h3>${acc.name}</h3>
                    <div class="prices">
                        <span>Pickup Total: #${acc.pickup.toLocaleString()}</span><br>
                        <span>Delivery Total: #${acc.delivery.toLocaleString()}</span>
                    </div>
                    <div class="action-buttons">
                        <button onclick="buyNow('${acc.name}', ${acc.pickup}, ${acc.delivery})">Buy Now</button>
                        <button onclick="addToCart('${acc.name}', ${acc.pickup})">Add to Cart</button>
                    </div>
                </div>
            `;
        });
    }
    window.addEventListener('DOMContentLoaded', function() {
        getCurrentUser() ? (showMain(), onMainLoad()) : showLogin();
    });

    // --- BROADCAST NOTIFICATION SYSTEM ---
    // Replace with your SheetBest endpoint for broadcast messages
    const BROADCAST_URL = 'https://api.sheetbest.com/sheets/YOUR_BROADCAST_SHEET_ID';

    // Admin send broadcast
    document.getElementById('broadcastForm').onsubmit = function(e) {
        e.preventDefault();
        const msg = document.getElementById('broadcastMsg').value.trim();
        if (!msg) return;
        const id = Date.now().toString();
        fetch(BROADCAST_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, msg, time: new Date().toLocaleString() })
        }).then(() => {
            alert('Message sent!');
            document.getElementById('broadcastMsg').value = '';
        });
    };

    // User receive broadcast
    function getShownBroadcastIds() {
        return JSON.parse(localStorage.getItem('shown_broadcast_ids') || '[]');
    }
    function addShownBroadcastId(id) {
        let ids = getShownBroadcastIds();
        ids.push(id);
        localStorage.setItem('shown_broadcast_ids', JSON.stringify(ids));
    }
    function showBroadcastNotification(msg) {
        const n = document.getElementById('notification');
        const dot = document.getElementById('notifDot');
        n.textContent = msg;
        n.style.background = "#007bff";
        n.style.display = 'block';
        dot.style.display = 'block';
        saveNotification(msg);
        clearTimeout(window._broadcastNotifTimeout);
        window._broadcastNotifTimeout = setTimeout(() => {
            n.style.display = 'none';
            dot.style.display = 'none';
        }, 4000);
    }
    function showBroadcastOnce(msg, id) {
        let ids = getShownBroadcastIds();
        if (ids.includes(id)) return;
        addShownBroadcastId(id);
        showBroadcastNotification(msg);
    }
    // Poll for new broadcast messages every 5 seconds
    function pollBroadcasts() {
        fetch(BROADCAST_URL)
            .then(res => res.json())
            .then(data => {
                data.forEach(m => {
                    if (m.id && m.msg) {
                        showBroadcastOnce(m.msg, m.id);
                    }
                });
            });
    }
    setInterval(pollBroadcasts, 5000);
    pollBroadcasts();
    </script>
</body>
</html>